---
# ============================================================================
# TEST SUITE 4: Performance Benchmark (wrapper-compatible)
# ============================================================================
# Run with custom runner (supports `performance` block per test):
#   python abc.py api_test/suites/test_suite_4_performance.yaml --perf --async
# Or with pyresttest vanilla (no performance block):
#   pyresttest --url http://localhost:8000 api_test/suites/test_suite_4_performance.yaml
# ============================================================================

- config:
    testset: "Suite 4: Performance Benchmark (Wrapper)"
    timeout: 30

- test:
    name: "Login"
    url: http://localhost:8000/api/login
    method: POST
    headers:
      Content-Type: application/json
      Accept: application/json
    body: '{"email":"1@gmail.com","password":"Bao12345"}'
    expected_status: [200]
    extract_binds:
      - token: { jsonpath_mini: access_token }

# Performance test - endpoint nhẹ
- test:
    name: "Performance Test - Get User Info (Fast)"
    url: http://localhost:8000/api/me
    method: GET
    headers:
      template: { "Authorization": "Bearer $token" }
    expected_status: [200]
  benchmark:
    name: "Benchmark - Get User Info (Fast)"
    method: GET
    url: http://localhost:8000/api/me
    mode: sync
    benchmark_runs: 100
    concurrency: 10
    threshold_ms: 200
    ramp_up_seconds: 10
    throttle_ms: 50
    retry:
      max_retries: 2
      backoff_base: 0.5
      backoff_max: 5
      retry_statuses: [429, 500]
    rps_mode: response
    metrics: [total_time]
    output_format: json

# Performance test - endpoint có thể chậm hơn
- test:
    name: "Performance Test - Get All Likes (Medium)"
    url: http://localhost:8000/api/getAllLikes
    method: GET
    headers:
      template: { "Authorization": "Bearer $token" }
    expected_status: [200]
  benchmark:
    name: "Benchmark - Get All Likes (Medium)"
    method: GET
    url: http://localhost:8000/api/getAllLikes
    mode: sync
    benchmark_runs: 100
    concurrency: 15
    threshold_ms: 300
    ramp_up_seconds: 10
    throttle_ms: 50
    retry:
      max_retries: 2
      backoff_base: 0.5
      backoff_max: 5
      retry_statuses: [429, 500]
    rps_mode: response
    metrics: [total_time]
    output_format: json

- test:
    name: "Performance Test - Get Post By ID (Fast)"
    url: http://localhost:8000/api/getPostById/1
    method: GET
    headers:
      template: { "Authorization": "Bearer $token" }
    expected_status: [200, 404]
  benchmark:
    name: "Benchmark - Get Post By ID (Fast)"
    method: GET
    url: http://localhost:8000/api/getPostById/1
    headers:
      template: { "Authorization": "Bearer $token" }
    mode: sync
    benchmark_runs: 100
    concurrency: 10
    threshold_ms: 250
    ramp_up_seconds: 10
    throttle_ms: 50
    retry:
      max_retries: 2
      backoff_base: 0.5
      backoff_max: 5
      retry_statuses: [429, 500]
    rps_mode: response
    metrics: [total_time]
    output_format: json
