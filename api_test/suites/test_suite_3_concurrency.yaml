# Test Suite 3 – Concurrency Test (Parallel Requests)
# Objective: Evaluate concurrent handling, surface race-conditions/bottlenecks,
# and validate concurrency behavior for upgraded framework.
#
# TC mapping:
# S3-T1  Login                 POST  /api/login                -> 200 (extract token)
# S3-T2..S3-T10  Concurrent access (mix of GET /api/getAllLikes, /api/getPostById/1, /api/me)
#                 Run concurrently with max_concurrency = 10. Expected: 200 or 404 for resource endpoints.
- config:
    testset: "Suite 1: Basic Auth & User"
    timeout: 10

- test:
    name: "S3-T1 Login for concurrency tests"
    url: "http://localhost:8000/api/login"
    method: POST
    headers:
      Content-Type: "application/json"
    body: '{"email":"1@gmail.com","password":"Bao12345"}'
    expected_status: [200]
    extract_binds:
      - token: { jsonpath_mini: "access_token" }

# Concurrent requests group (S3-T2 .. S3-T10)
# Each of the following tests is intended to be executed in parallel by the runner
# with a maximum concurrency of 10 (runner flag: --max-concurrency 10 or use test metadata).

- benchmark:
    name: "Benchmark - Get User Info (Concurrency Async)"
    description: >
      Concurrent benchmark for /api/me endpoint to evaluate parallel request handling.

    method: GET
    url: /api/me

    headers:
      Authorization: "Bearer $token"

    # === CONCURRENCY CORE ===
    mode: async
    concurrency: 15
    benchmark_runs: 500

    ramp_up_seconds: 15
    throttle_ms: 50

    # === EXPECTATION ===
    expected_status: [200, 401, 429]

    # === SLA (PyRestTest chỉ check max_time ngầm) ===
    threshold_ms: 300
    retry:
      max_retries: 2
      backoff_base: 0.5
      backoff_max: 5
      retry_statuses: [429, 500]
    metrics:
      - total_time

    output_format: json
